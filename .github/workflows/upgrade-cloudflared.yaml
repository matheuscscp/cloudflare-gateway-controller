name: upgrade-cloudflared

on:
  schedule:
    - cron: "0 8 * * 1" # every Monday
  workflow_dispatch:

jobs:
  upgrade:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          token: ${{ secrets.BOT_GITHUB_TOKEN }}
          persist-credentials: false

      - name: Get latest cloudflared release
        id: release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          tag=$(gh api repos/cloudflare/cloudflared/releases/latest --jq '.tag_name')
          echo "tag=$tag" >> "$GITHUB_OUTPUT"

      - name: Set up crane
        uses: imjasonh/setup-crane@6da1ae018866400525525ce74ff892880c099987 # v0.5

      - name: Log in to GHCR
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          # Use a dedicated Docker config for GHCR so the login
          # does not corrupt the default config used to pull from
          # Docker Hub.
          mkdir -p "$RUNNER_TEMP/ghcr-docker"
          echo "$GITHUB_TOKEN" | DOCKER_CONFIG="$RUNNER_TEMP/ghcr-docker" \
            crane auth login ghcr.io --username=token --password-stdin

      - name: Get upstream digest and check GHCR
        id: check
        env:
          TAG: ${{ steps.release.outputs.tag }}
          DOCKER_CONFIG: ${{ runner.temp }}/ghcr-docker
          REPOSITORY: ${{ github.repository }}
        run: |
          dst="ghcr.io/$REPOSITORY/cloudflared"
          echo "dst=$dst" >> "$GITHUB_OUTPUT"
          upstream_digest=$(crane digest "cloudflare/cloudflared:$TAG")
          echo "digest=$upstream_digest" >> "$GITHUB_OUTPUT"
          if ghcr_digest=$(crane digest "$dst:$TAG" 2>/dev/null) && [ "$ghcr_digest" = "$upstream_digest" ]; then
            echo "needs_copy=false" >> "$GITHUB_OUTPUT"
          else
            echo "needs_copy=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Copy image
        if: steps.check.outputs.needs_copy == 'true'
        env:
          DST: ${{ steps.check.outputs.dst }}
          TAG: ${{ steps.release.outputs.tag }}
          DOCKER_CONFIG: ${{ runner.temp }}/ghcr-docker
        run: |
          crane copy "cloudflare/cloudflared:$TAG" "$DST:$TAG"

      - name: Install cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Verify signature
        id: verify
        env:
          DST: ${{ steps.check.outputs.dst }}
          TAG: ${{ steps.release.outputs.tag }}
          DIGEST: ${{ steps.check.outputs.digest }}
          REPOSITORY: ${{ github.repository }}
        continue-on-error: true
        run: |
          cosign verify \
            --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
            --certificate-identity="https://github.com/${REPOSITORY}/.github/workflows/upgrade-cloudflared.yaml@refs/heads/main" \
            "$DST:$TAG@$DIGEST"

      - name: Sign image
        if: steps.verify.outcome != 'success'
        env:
          DST: ${{ steps.check.outputs.dst }}
          TAG: ${{ steps.release.outputs.tag }}
          DIGEST: ${{ steps.check.outputs.digest }}
          DOCKER_CONFIG: ${{ runner.temp }}/ghcr-docker
        run: |
          cosign sign --yes "$DST:$TAG@$DIGEST"

      - name: Verify signature after signing
        if: steps.verify.outcome != 'success'
        env:
          DST: ${{ steps.check.outputs.dst }}
          TAG: ${{ steps.release.outputs.tag }}
          DIGEST: ${{ steps.check.outputs.digest }}
          REPOSITORY: ${{ github.repository }}
        run: |
          cosign verify \
            --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
            --certificate-identity="https://github.com/${REPOSITORY}/.github/workflows/upgrade-cloudflared.yaml@refs/heads/main" \
            "$DST:$TAG@$DIGEST"

      - name: Update Go code
        env:
          DST: ${{ steps.check.outputs.dst }}
          TAG: ${{ steps.release.outputs.tag }}
          DIGEST: ${{ steps.check.outputs.digest }}
        run: |
          sed -i "s|DefaultCloudflaredImage = \"[^\"]*\"|DefaultCloudflaredImage = \"${DST}:${TAG}@${DIGEST}\"|" \
            internal/controller/gateway_controller.go

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@5e914681df9dc83aa4e4905692ca88beb2f9e91f # v7.0.5
        with:
          token: ${{ secrets.BOT_GITHUB_TOKEN }}
          commit-message: Upgrade cloudflared to ${{ steps.release.outputs.tag }}
          committer: GitHub <noreply@github.com>
          signoff: true
          branch: upgrade-cloudflared
          title: Upgrade cloudflared to ${{ steps.release.outputs.tag }}
          body: |
            Automated cloudflared upgrade to `${{ steps.release.outputs.tag }}`.

            Image: `${{ steps.check.outputs.dst }}:${{ steps.release.outputs.tag }}@${{ steps.check.outputs.digest }}`

            Generated by: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
