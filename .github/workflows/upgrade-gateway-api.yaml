name: upgrade-gateway-api

on:
  schedule:
    - cron: "0 8 * * 1" # every Monday
  workflow_dispatch:

jobs:
  upgrade:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          token: ${{ secrets.BOT_GITHUB_TOKEN }}
          persist-credentials: false

      - name: Get latest Gateway API release
        id: release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          tag=$(gh api repos/kubernetes-sigs/gateway-api/releases/latest --jq '.tag_name')
          echo "tag=$tag" >> "$GITHUB_OUTPUT"

      - name: Set up Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version-file: go.mod

      - name: Upgrade Go module
        env:
          TAG: ${{ steps.release.outputs.tag }}
        run: |
          go get "sigs.k8s.io/gateway-api@$TAG"
          go mod tidy

      - name: Update test Gateway API version
        env:
          TAG: ${{ steps.release.outputs.tag }}
        run: |
          version="${TAG#v}"
          sed -i "s/semver.MustParse(\"[^\"]*\")/semver.MustParse(\"${version}\")/" \
            internal/controller/suite_test.go

      - name: Download YAMLs
        env:
          TAG: ${{ steps.release.outputs.tag }}
        run: |
          dest=charts/cloudflare-gateway-controller/templates/standard-api.yaml
          curl -fsSL -o "$dest" \
            "https://github.com/kubernetes-sigs/gateway-api/releases/download/$TAG/standard-install.yaml"
          printf '%s\n%s\n%s\n' '{{- if eq .Values.api.channel "standard" }}' "$(cat "$dest")" '{{- end }}' > "$dest"
          dest=charts/cloudflare-gateway-controller/templates/experimental-api.yaml
          curl -fsSL -o "$dest" \
            "https://github.com/kubernetes-sigs/gateway-api/releases/download/$TAG/experimental-install.yaml"
          printf '%s\n%s\n%s\n' '{{- if eq .Values.api.channel "experimental" }}' "$(cat "$dest")" '{{- end }}' > "$dest"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@5e914681df9dc83aa4e4905692ca88beb2f9e91f # v7.0.5
        with:
          token: ${{ secrets.BOT_GITHUB_TOKEN }}
          commit-message: Upgrade Gateway API to ${{ steps.release.outputs.tag }}
          committer: GitHub <noreply@github.com>
          signoff: true
          branch: upgrade-api
          title: Upgrade Gateway API to ${{ steps.release.outputs.tag }}
          body: |
            Automated Gateway API upgrade to `${{ steps.release.outputs.tag }}`.

            Release: https://github.com/kubernetes-sigs/gateway-api/releases/tag/${{ steps.release.outputs.tag }}

            Generated by: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
