# Copyright 2026 Matheus Pimenta.
# SPDX-License-Identifier: AGPL-3.0

name: Docker Build
description: Build the controller Docker image using buildx.

inputs:
  platforms:
    description: Target platforms (comma-separated).
    default: linux/amd64
  push:
    description: Push the image to a registry.
    default: "false"
  load:
    description: Load the image into the local Docker daemon.
    default: "false"
  tags:
    description: Image tags (newline or comma-separated).
    required: true
  labels:
    description: Image labels from metadata-action.
    default: ""
  sbom:
    description: Generate SBOM attestation.
    default: "false"
  provenance:
    description: Generate provenance attestation.
    default: "false"
  images:
    description: Image names for docker/metadata-action (newline-separated).
    default: ""

outputs:
  metadata-tags:
    description: Tags generated by docker/metadata-action.
    value: ${{ steps.meta.outputs.tags }}
  metadata-labels:
    description: Labels generated by docker/metadata-action.
    value: ${{ steps.meta.outputs.labels }}

runs:
  using: composite
  steps:
    - name: Set up QEMU
      uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3.7.0

    - name: Set up Docker Buildx
      id: buildx
      uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

    - name: Generate image metadata
      if: inputs.images != ''
      id: meta
      uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5.10.0
      with:
        images: ${{ inputs.images }}
        tags: ${{ inputs.tags }}

    - name: Build
      uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6.19.2
      with:
        context: .
        platforms: ${{ inputs.platforms }}
        push: ${{ inputs.push }}
        load: ${{ inputs.load }}
        tags: ${{ steps.meta.outputs.tags || inputs.tags }}
        labels: ${{ steps.meta.outputs.labels || inputs.labels }}
        sbom: ${{ inputs.sbom }}
        provenance: ${{ inputs.provenance }}
        builder: ${{ steps.buildx.outputs.name }}
